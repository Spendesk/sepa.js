"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var extendStatics=function(t,e){return(extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)e.hasOwnProperty(r)&&(t[r]=e[r])})(t,e)};function __extends(t,e){function r(){this.constructor=t}extendStatics(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)}var XSI_NAMESPACE="http://www.w3.org/2001/XMLSchema-instance",XSI_NS="urn:iso:std:iso:20022:tech:xsd:",DEFAULT_XML_VERSION="1.0",DEFAULT_XML_ENCODING="UTF-8",DEFAULT_PAIN_FORMAT="pain.008.001.02",ID_SEPARATOR=".";function setIDSeparator(t){ID_SEPARATOR=t}var VALIDATIONS_ENABLED=!0;function enableValidations(t){VALIDATIONS_ENABLED=!!t}var SEPATypes={"pain.001.001.02":"pain.001.001.02","pain.001.003.02":"pain.001.003.02","pain.001.001.03":"CstmrCdtTrfInitn","pain.001.003.03":"CstmrCdtTrfInitn","pain.008.001.01":"pain.008.001.01","pain.008.003.01":"pain.008.003.01","pain.008.001.02":"CstmrDrctDbtInitn","pain.008.003.02":"CstmrDrctDbtInitn"},InvalidSupplierError=function(s){function o(t,e){for(var r=[],n=2;n<arguments.length;n++)r[n-2]=arguments[n];var i=s.apply(this,r)||this;return Error.captureStackTrace&&Error.captureStackTrace(i,o),i.name="InvalidSupplierError",i.supplierName=t,i.invalidParams=e,i}return __extends(o,s),o}(Error);function getPainXMLVersion(t){var e=0===t.indexOf("pain.008")?1:0;return parseInt(t.substr(-2),10)+e}var SepaDocument=function(){function t(t){this._paymentInfo=[],this._xmlVersion=DEFAULT_XML_VERSION,this._xmlEncoding=DEFAULT_XML_ENCODING,this._painFormat=t||DEFAULT_PAIN_FORMAT,this._type=SEPATypes[this._painFormat],this.grpHdr=new SepaGroupHeader(this._painFormat)}return t.prototype.addPaymentInfo=function(t){if(!(t instanceof SepaPaymentInfo))throw new Error("Given payment is not member of the PaymentInfo class");t.overrideReference?t.id=t.overrideReference:t.id?t.id=this.grpHdr.id+ID_SEPARATOR+t.id:t.id=this.grpHdr.id+ID_SEPARATOR+this._paymentInfo.length,this._paymentInfo.push(t)},t.prototype.createPaymentInfo=function(){return new SepaPaymentInfo(this._painFormat)},t.prototype.normalize=function(){for(var t=0,e=0,r=0,n=this._paymentInfo.length;r<n;++r)this._paymentInfo[r].normalize(),t+=this._paymentInfo[r].controlSum,e+=this._paymentInfo[r].transactionCount;this.grpHdr.controlSum=t,this.grpHdr.transactionCount=e},t.prototype.toXML=function(){this.normalize();var t=XSI_NS+this._painFormat,e=createDocument(t,"Document");e.xmlVersion=this._xmlVersion,e.xmlEncoding=this._xmlEncoding;var r=e.documentElement;r.setAttribute("xmlns:xsi",XSI_NAMESPACE),r.setAttribute("xsi:schemaLocation",XSI_NS+this._painFormat+" "+this._painFormat+".xsd");var n=e.createElementNS(t,this._type);n.appendChild(this.grpHdr.toXML(e));for(var i=0,s=this._paymentInfo.length;i<s;++i)n.appendChild(this._paymentInfo[i].toXML(e));return e.documentElement.appendChild(n),e},t.prototype.toString=function(){var t=this.toXML();return'<?xml version="'+t.xmlVersion+'" encoding="'+t.xmlEncoding+'"?>'+serializeToString(t)},t.Types=SEPATypes,t}(),SepaGroupHeader=function(){function t(t){this.id="",this.transactionCount=0,this.initiatorName="",this.cifNumber="",this.cucNumber="",this.controlSum=0,this.batchBooking=!1,this.grouping="MIXD",this._painFormat=t}return t.prototype.toXML=function(t){var e=createXMLHelper(t,!0,!0),r=t.createElementNS(t.documentElement.namespaceURI,"GrpHdr"),n=getPainXMLVersion(this._painFormat);e(r,"MsgId",this.id),e(r,"CreDtTm",this.created.toISOString()),2===n&&e(r,"BtchBookg",this.batchBooking.toString()),e(r,"NbOfTxs",this.transactionCount),e(r,"CtrlSum",this.controlSum.toFixed(2)),2===n&&e(r,"Grpg",this.grouping);var i=createXMLHelper(t,!0,!1)(r,"InitgPty");if(e(i,"Nm",this.initiatorName),this.cifNumber&&e(i,"Id","OrgId","Othr","Id",this.cifNumber),this.cucNumber){var s=createXMLHelper(t,!0,!1)(i,"Id","OrgId","Othr");e(s,"Id",this.cucNumber),e(s,"Issr","CBI")}return r},t.prototype.toString=function(){return serializeToString(this.toXML(this))},t}(),PaymentInfoTypes={DirectDebit:"DD",Transfer:"TRF"},SepaPaymentInfo=function(){function t(t){this._payments=[],this.id="",this.batchBooking=!1,this.grouping="MIXD",this.controlSum=0,this.localInstrumentation="CORE",this.sequenceType="FRST",this.collectionDate=null,this.requestedExecutionDate=null,this.creditorId="",this.creditorName="",this.creditorStreet=null,this.creditorCity=null,this.creditorCountry=null,this.creditorIBAN="",this.creditorBIC="",this.creditorMemberId="",this.debtorId="",this.debtorName="",this.debtorStreet=null,this.debtorCity=null,this.debtorCountry=null,this.debtorIBAN="",this.debtorBIC="",this.debtorMemberId="",this.instructionPriority="NORM",this.categoryPurpose="",this.overrideReference="",this._painFormat=t,this.method=0===t.indexOf("pain.001")?PaymentInfoTypes.Transfer:PaymentInfoTypes.DirectDebit}return Object.defineProperty(t.prototype,"transactionCount",{get:function(){return this._payments.length},enumerable:!0,configurable:!0}),t.prototype.normalize=function(){for(var t=0,e=0,r=this._payments.length;e<r;++e)t+=this._payments[e].amount;this.controlSum=t},t.prototype.addTransaction=function(t){if(!(t instanceof SepaTransaction))throw new Error("Given Transaction is not member of the SepaTransaction class");t.overrideReference?t.id=t.overrideReference:t.id?t.id=this.id+ID_SEPARATOR+t.id:t.id=this.id+ID_SEPARATOR+this._payments.length,this._payments.push(t)},t.prototype.createTransaction=function(){return new SepaTransaction(this._painFormat)},t.prototype.validate=function(){var t=this.method===PaymentInfoTypes.DirectDebit?"creditor":"debtor";assert_fixed(this.localInstrumentation,["CORE","COR1","B2B"],"localInstrumentation"),assert_fixed(this.sequenceType,["FRST","RCUR","OOFF","FNAL"],"sequenceType"),this.method===PaymentInfoTypes.DirectDebit?assert_date(this.collectionDate,"collectionDate"):assert_date(this.requestedExecutionDate,"requestedExecutionDate"),assert_cid(this[t+"Id"],t+"Id"),assert_debitor({name:this[t+"Name"],street:this[t+"Street"],city:this[t+"City"],country:this[t+"Country"],iban:this[t+"IBAN"],bic:this[t+"BIC"],pullFrom:t}),assert_length(this._payments.length,1,null,"_payments")},t.prototype.toXML=function(t){VALIDATIONS_ENABLED&&this.validate();var e=createXMLHelper(t,!0,!1),r=createXMLHelper(t,!0,!0),n=t.createElementNS(t.documentElement.namespaceURI,"PmtInf");r(n,"PmtInfId",this.id),r(n,"PmtMtd",this.method),3===getPainXMLVersion(this._painFormat)&&(r(n,"BtchBookg",this.batchBooking.toString()),r(n,"NbOfTxs",this.transactionCount),r(n,"CtrlSum",this.controlSum.toFixed(2)));var i=e(n,"PmtTpInf");r(i,"InstrPrty",this.instructionPriority),r(i,"SvcLvl","Cd","SEPA"),this.categoryPurpose&&r(i,"CtgyPurp","Cd",this.categoryPurpose),this.method===PaymentInfoTypes.DirectDebit?(r(i,"LclInstrm","Cd",this.localInstrumentation),r(i,"SeqTp",this.sequenceType),r(n,"ReqdColltnDt",this.collectionDate.toISOString().substr(0,10))):r(n,"ReqdExctnDt",this.requestedExecutionDate.toISOString().substr(0,10));var s=this.method===PaymentInfoTypes.DirectDebit?"creditor":"debtor",o=this.method===PaymentInfoTypes.DirectDebit?"Cdtr":"Dbtr",a=e(n,o);if(r(a,"Nm",this[s+"Name"]),this[s+"Street"]&&this[s+"City"]&&this[s+"Country"]){var h=e(a,"PstlAdr");r(h,"Ctry",this[s+"Country"]),r(h,"AdrLine",this[s+"Street"]),r(h,"AdrLine",this[s+"City"])}if(r(n,o+"Acct","Id","IBAN",this[s+"IBAN"]),this[s+"BIC"]){var c=createXMLHelper(t,!0,!1)(n,o+"Agt","FinInstnId");r(c,"BIC",this[s+"BIC"]),this[s+"MemberId"]&&r(c,"ClrSysMmbId","MmbId",this[s+"MemberId"])}else r(n,o+"Agt","FinInstnId","Othr","Id","NOTPROVIDED");if(r(n,"ChrgBr","SLEV"),this.method===PaymentInfoTypes.DirectDebit){var d=e(n,"CdtrSchmeId","Id","PrvtId","Othr");r(d,"Id",this.creditorId),r(d,"SchmeNm","Prtry","SEPA")}for(var u=0,p=this._payments.length;u<p;++u)n.appendChild(this._payments[u].toXML(t));return n},t.prototype.toString=function(){return serializeToString(this.toXML(this))},t.PaymentInfoTypes=PaymentInfoTypes,t}(),TransactionTypes={DirectDebit:"DrctDbtTxInf",Transfer:"CdtTrfTxInf"},SepaTransaction=function(){function t(t){this.id="",this.end2endId="",this.currency="EUR",this.amount=0,this.ammendment="",this.purposeCode=null,this.mandateId="",this.mandateSignatureDate=null,this.debtorName="",this.debtorStreet=null,this.debtorCity=null,this.debtorCountry=null,this.debtorIBAN="",this.debtorBIC="",this.remittanceInfo="",this.creditorName="",this.creditorStreet=null,this.creditorCity=null,this.creditorCountry=null,this.creditorIBAN="",this.creditorBIC="",this._painFormat=t,this._type=0===t.indexOf("pain.001")?TransactionTypes.Transfer:TransactionTypes.DirectDebit}return t.prototype.validate=function(){var t=this._type===TransactionTypes.Transfer?"creditor":"debtor";assert_sepa_id_set1(this.end2endId,"end2endId"),assert_range(this.amount,.01,999999999.99,"amount"),parseInt(this.amount.toString())!=this.amount&&assert(this.amount.toString().split(".")[1].length<=2,"amount has too many fractional digits"),assert_length(this.purposeCode,1,4,"purposeCode"),assert_sepa_id_set2(this.mandateId,"mandateId"),assert_date(this.mandateSignatureDate,"mandateSignatureDate"),assert_debitor({name:this[t+"Name"],street:this[t+"Street"],city:this[t+"City"],country:this[t+"Country"],iban:this[t+"IBAN"],bic:this[t+"BIC"],pullFrom:t}),assert_length(this.remittanceInfo,null,140,"remittanceInfo")},t.prototype.toXML=function(t){VALIDATIONS_ENABLED&&this.validate();var e=this._type===TransactionTypes.Transfer?"creditor":"debtor",r=this._type===TransactionTypes.Transfer?"Cdtr":"Dbtr",n=createXMLHelper(t,!0,!1),i=createXMLHelper(t,!1,!0),s=createXMLHelper(t,!0,!0),o=t.createElementNS(t.documentElement.namespaceURI,this._type),a=n(o,"PmtId");if(s(a,"InstrId",this.id),s(a,"EndToEndId",this.end2endId),this._type===TransactionTypes.DirectDebit){s(o,"InstdAmt",this.amount.toFixed(2)).setAttribute("Ccy",this.currency);var h=n(o,"DrctDbtTx","MndtRltdInf");s(h,"MndtId",this.mandateId),s(h,"DtOfSgntr",this.mandateSignatureDate.toISOString().substr(0,10)),this.ammendment?(s(h,"AmdmntInd","true"),s(h,"AmdmnInfDtls",this.ammendment)):s(h,"AmdmntInd","false")}else s(o,"Amt","InstdAmt",this.amount.toFixed(2)).setAttribute("Ccy",this.currency);this[e+"BIC"]?s(o,r+"Agt","FinInstnId","BIC",this[e+"BIC"]):s(o,r+"Agt","FinInstnId","Othr","Id","NOTPROVIDED");var c=n(o,r);if(s(c,"Nm",this[e+"Name"]),this[e+"Street"]&&this[e+"City"]&&this[e+"Country"]){var d=n(c,"PstlAdr");s(d,"Ctry",this.debtorCountry),s(d,"AdrLine",this.debtorStreet),s(d,"AdrLine",this.debtorCity)}return s(o,r+"Acct","Id","IBAN",this[e+"IBAN"]),s(o,"RmtInf","Ustrd",this.remittanceInfo),i(o,"Purp","Cd",this.purposeCode),o},t.TransactionTypes=TransactionTypes,t}();function _replaceChars(t){for(var e="",r=0,n=t.length;r<n;++r){var i=t.charCodeAt(r);65<=i&&i<=90?e+=(i-55).toString():97<=i&&i<=122?e+=(i-87).toString():48<=i&&i<=57&&(e+=t[r])}return e}function _txtMod97(t){for(var e=0,r=0,n=t.length;r<n;++r)e=(10*e+parseInt(t[r],10))%97;return e}function validateIBAN(t){return 1===_txtMod97(_replaceChars(t.substr(4)+t.substr(0,4)))}function checksumIBAN(t){var e=_txtMod97(_replaceChars(t.substr(4)+t.substr(0,2)+"00"));return t.substr(0,2)+("0"+(98-e)).substr(-2,2)+t.substr(4)}function validateCreditorID(t){return 1===_txtMod97(_replaceChars(t.substr(7)+t.substr(0,4)))}function checksumCreditorID(t){var e=_txtMod97(_replaceChars(t.substr(7)+t.substr(0,2)+"00"));return t.substr(0,2)+("0"+(98-e)).substr(-2,2)+t.substr(4)}function assert_debitor(t){var e=t.name,r=t.street,n=t.city,i=t.country,s=t.iban,o=t.bic,a=t.pullFrom,h="",c=[];e&&70<e.length&&(c.push("name"),h="debitor name is too long."),r&&70<r.length&&(c.push("street"),h="debitor street is too long."),n&&70<n.length&&(c.push("city"),h="debitor city is too long."),i&&2<i.length&&(c.push("country"),h="debitor country is too long.");try{assert_name(e,a)}catch(t){h=a+' has invalid name: "'+e+'"',c.push(a+"Name")}try{assert_name(e,a)}catch(t){h=a+' has invalid name: "'+e+'"',c.push(a+"Name")}try{assert_iban(s,a+"IBAN"),assert_fixed(o.length,[0,8,11],a+"BIC"),assert(0===o.length||o.substr(4,2)===s.substr(0,2),h)}catch(t){h="country mismatch in BIC/IBAN for "+a+" called "+e+" with BIC: "+o+" and IBAN: "+s,c.push("IBAN/BIC")}if(0<c.length)throw new InvalidSupplierError(e,c,h)}function assert(t,e){if(!t)throw new Error(e)}function assert_fixed(t,e,r){if(e.indexOf(t)<0)throw new Error(r+" must have any value of: "+e.join(" ")+"(found: "+t+")")}function assert_length(t,e,r,n){if(null!==e&&t&&t.length<e||null!==r&&t&&t.length>r)throw new Error(n+" has invalid string length, expected "+e+" < "+t+" < "+r)}function assert_range(t,e,r,n){if(t<e||r<t)throw new Error(n+" does not match range "+e+" < "+t+" < "+r)}function assert_iban(t,e){if(!validateIBAN(t))throw new Error(e+' has invalid IBAN "'+t+'"')}function assert_name(t,e){if(!t||!t.trim().length)throw new Error(e+' has invalid name: "'+t+'"')}function assert_cid(t,e){if(!validateCreditorID(t))throw new Error(e+' is invalid "'+t+'"')}function assert_date(t,e){if(!t||isNaN(t.getTime()))throw new Error(e+" has invalid date "+t)}function assert_sepa_id_set1(t,e){if(t&&!t.match(/([A-Za-z0-9]|[+|?|/|\-|:|(|)|.|,|'| ]){1,35}/))throw new Error(e+" doesn't match sepa id charset type 1 (found: \""+t+'")')}function assert_sepa_id_set2(t,e){if(t&&!t.match(/([A-Za-z0-9]|[+|?|/|\-|:|(|)|.|,|']){1,35}/))throw new Error(e+" doesn't match sepa id charset type 2 (found: \""+t+'")')}function createDocument(t,e){return"undefined"!=typeof document&&void 0!==document.implementation?document.implementation.createDocument(t,e,null):(new(require("xmldom").DOMImplementation)).createDocument(t,e)}function serializeToString(t){return(new(require("xmldom").XMLSerializer)).serializeToString(t)}function createXMLHelper(o,a,h){return function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=t[0],n=h&&t[t.length-1],i=h?t.length-1:t.length;if(a||n||0===n){for(var s=1;s<i;++s)r=r.appendChild(o.createElementNS(o.documentElement.namespaceURI,t[s]));return h&&(r.textContent=n),r}return null}}var extractABICodeFromIBAN=function(t){return t.substring(5,10)},CountryHelpers={italy:{extractABICodeFromIBAN:extractABICodeFromIBAN}};exports.CountryHelpers=CountryHelpers,exports.Document=SepaDocument,exports.checksumCreditorID=checksumCreditorID,exports.checksumIBAN=checksumIBAN,exports.enableValidations=enableValidations,exports.setIDSeparator=setIDSeparator,exports.validateCreditorID=validateCreditorID,exports.validateIBAN=validateIBAN;
